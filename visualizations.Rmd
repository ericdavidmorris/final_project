---
title: "Visualizations"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(viridis)
library(ggridges)
library(lubridate)
library(stringr)
library(kableExtra)
```

```{r Data Import Function, include=FALSE, message =FALSE}
# Removed col names type for now and went with automatic column parsing

citibike_import = function(file) {
  
  df = read_csv(file, col_names = TRUE) %>%
    janitor::clean_names() %>% 
    separate(start_time, into = c("start_date", "start_time"), sep = " ") %>% 
    separate(stop_time, into = c("stop_date", "stop_time"), sep = " ") %>% 
    separate(start_date, into = c("start_year", "start_month", "start_day"), sep = "-") %>% 
    separate(stop_date, into = c("stop_year", "stop_month", "stop_day"), sep = "-") %>% 
    mutate(user_type = tolower(user_type),
           gender = as.factor(gender - 1),
           start_month = ifelse(start_month == "01", "January", "March"),
           stop_month = ifelse(start_month == "01", "January", "March"),
           trip_minutes = (trip_duration / 60),
           rider_age = (2017 - birth_year),
           start_hour = as.numeric(str_sub(start_time, 0, 2)),
           overnight = ifelse(start_hour < 06 & start_hour >= 00, 1, 0),
           morning = ifelse(start_hour < 12 & start_hour >= 06, 1, 0),
           afternoon = ifelse(start_hour < 18 & start_hour >= 12, 1, 0),
           night = ifelse(start_hour <= 24 & start_hour >= 18, 1, 0)) %>% 
    filter(user_type == "subscriber",
           trip_minutes > 5,
           trip_minutes <= 45,
           !start_station_name %in% c("Bressler", "Kiosk in a box Motivate", "NYCBS Depot - FAR", "NYCBS Depot - SSP", "NYCBS Depot - STY", "NYCBS Depot - DYR", "NYCBS Depot BAL - DYR", "SSP Tech Workshop", "Penn Station Valet", "Penn Station Valet - Valet Scan"),
           !end_station_name %in% c("Bressler", "Kiosk in a box Motivate", "NYCBS Depot - FAR", "NYCBS Depot - SSP", "NYCBS Depot - STY", "NYCBS Depot - DYR", "NYCBS Depot BAL - DYR", "SSP Tech Workshop", "Penn Station Valet", "Penn Station Valet - Valet Scan"),
           gender != -1,
           rider_age < 100)
  
  df
  
}

citibike_tidy = 
  bind_rows(citibike_import("./data/201701-citibike-tripdata.csv.zip"),
            citibike_import("./data/201703-citibike-tripdata.csv.zip"))

# Reading the data directly from website doesn't work - thousands of parsing failures, both with auto parsing and when specifing column parsing in function
# citibike_import("https://s3.amazonaws.com/tripdata/201701-citibike-tripdata.csv.zip"),
# citibike_import("https://s3.amazonaws.com/tripdata/201703-citibike-tripdata.csv.zip"))
```

## Station usage

The following plots depict the number of trips that started from and ended at each of the current Citi Bike stations, for January and March of 2017.

There was little difference between starting station usage in the two months. The most trips were started at `r citibike_tidy %>% filter(start_month == "January") %>% group_by(start_station_name) %>% summarize(n = n()) %>% top_n(1, n) %>% select(-n)`, with `r citibike_tidy %>% filter(start_month == "January") %>% group_by(start_station_name) %>% summarize(n = n()) %>% top_n(1, n) %>% select(-start_station_name)` trips in January and `r citibike_tidy %>% filter(start_month == "March") %>% group_by(start_station_name) %>% summarize(n = n()) %>% top_n(1, n) %>% select(-start_station_name)` trips in March.

```{r start stations, echo=FALSE}
#plotly works nicely now

citibike_start_jan =
  citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(start_station_name, start_station_latitude, start_station_longitude) %>% 
  summarize(n = n()) %>% 
  mutate(text_label = str_c("Station name: ", start_station_name, '\n# of trips started at this station: ', n)) %>% 
  plot_ly(x = ~start_station_longitude, y = ~start_station_latitude, type = "scatter", mode = "markers",
          alpha = 0.5,
          color = ~n,
          text = ~text_label) %>% 
  layout(
    xaxis = list(title = "Longitude"),
    yaxis = list(title = "Latitude")
    ) %>% 
  colorbar(title = "Jan (n)")

## map of nyc based on lat/long, overlay ggplot on top? https://cran.r-project.org/web/packages/magick/vignettes/intro.html#combining

#Jan ggplot of plotly above

#citibike_tidy %>% 
#  filter(start_month == "January") %>% 
#  group_by(start_station_id, start_station_latitude, start_station_longitude) %>% 
#  summarize(n = n()) %>% 
#  ggplot(aes(x = start_station_longitude, y = start_station_latitude, color = n)) +
#  geom_point(alpha = 0.3) + 
#  scale_color_viridis() +
#  coord_cartesian() +
#  theme_classic()

citibike_start_mar =
  citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(start_station_name, start_station_latitude, start_station_longitude) %>% 
  summarize(n = n()) %>% 
  mutate(text_label = str_c("Station name: ", start_station_name, '\n# of trips started at this station: ', n)) %>% 
  plot_ly(x = ~start_station_longitude, y = ~start_station_latitude, type = "scatter", mode = "markers",
          alpha = 0.5,
          color = ~n,
          text = ~text_label) %>% 
  layout(
    xaxis = list(title = "Longitude"),
    yaxis = list(title = "Latitude")
    ) %>% 
  colorbar(title = "Mar (n)")

#March ggplot of plotly above

#citibike_tidy %>% 
#  filter(start_month == "March") %>% 
#  group_by(start_station_id, start_station_latitude, start_station_longitude) %>% 
#  summarize(n = n()) %>% 
#  ggplot(aes(x = start_station_longitude, y = start_station_latitude, color = n)) +
#  geom_point(alpha = 0.3) + 
#  scale_color_viridis() +
#  coord_cartesian() +
#  theme_classic()

subplot(
  citibike_start_jan %>% layout(showlegend = FALSE),
  citibike_start_mar %>% layout(showlegend = FALSE),
  margin = 0.05,
  shareX = TRUE, shareY = TRUE
) %>% 
layout(
  title = "Number of trips started at each station (2017)",
  annotations = list(
    list(x = 0.2 , y = 1.0, text = "January", showarrow = F, xref='paper', yref='paper'),
    list(x = 0.8 , y = 1.0, text = "March", showarrow = F, xref='paper', yref='paper'))
)
```

The station where the most trips ended was also `r citibike_tidy %>% filter(start_month == "January") %>% group_by(end_station_name) %>% summarize(n = n()) %>% top_n(1, n) %>% select(-n)`. In January, `r citibike_tidy %>% filter(start_month == "January") %>% group_by(end_station_name) %>% summarize(n = n()) %>% top_n(1, n) %>% select(-end_station_name)` trips ended at this station, and `r citibike_tidy %>% filter(start_month == "March") %>% group_by(end_station_name) %>% summarize(n = n()) %>% top_n(1, n) %>% select(-end_station_name)` trips ended here in March.

```{r end stations, echo=FALSE}
citibike_end_jan = 
  citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(end_station_name, end_station_latitude, end_station_longitude) %>% 
  summarize(n = n()) %>% 
  mutate(text_label = str_c("Station name: ", end_station_name, '\n# of trips started at this station: ', n)) %>% 
  plot_ly(x = ~end_station_longitude, y = ~end_station_latitude, type = "scatter", mode = "markers",
          alpha = 0.5,
          color = ~n,
          text = ~text_label) %>% 
  layout(
    xaxis = list(title = "Longitude"),
    yaxis = list(title = "Latitude")
    ) %>% 
  colorbar(title = "Jan (n)")

#Jan ggplot of plotly above
#citibike_tidy %>% 
#  filter(start_month == "January") %>% 
#  group_by(end_station_id, end_station_latitude, end_station_longitude) %>% 
#  summarize(n = n()) %>% 
#  ggplot(aes(x = end_station_longitude, y = end_station_latitude, color = n)) +
#  geom_point(alpha = 0.3) + 
#  scale_color_viridis() +
#  coord_cartesian() +
#  theme_classic()

citibike_end_mar = 
citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(end_station_name, end_station_latitude, end_station_longitude) %>% 
  summarize(n = n()) %>% 
  mutate(text_label = str_c("Station name: ", end_station_name, '\n# of trips started at this station: ', n)) %>% 
  plot_ly(x = ~end_station_longitude, y = ~end_station_latitude, type = "scatter", mode = "markers",
          alpha = 0.5,
          color = ~n,
          text = ~text_label) %>% 
  layout(
    xaxis = list(title = "Longitude"),
    yaxis = list(title = "Latitude")
    ) %>% 
  colorbar(title = "Mar (n)")

#March ggplot of plotly above
#citibike_tidy %>% 
#  filter(start_month == "March") %>% 
#  group_by(end_station_id, end_station_latitude, end_station_longitude) %>% 
#  summarize(n = n()) %>% 
#  ggplot(aes(x = end_station_longitude, y = end_station_latitude, color = n)) +
#  geom_point(alpha = 0.3) + 
#  scale_color_viridis() +
#  coord_cartesian() +
#  theme_classic()

subplot(
  citibike_end_jan %>% layout(showlegend = FALSE),
  citibike_end_mar %>% layout(showlegend = FALSE),
  margin = 0.05,
  shareX = TRUE, shareY = TRUE
) %>% 
layout(
  title = "Number of trips ended at each station (2017)",
  annotations = list(
    list(x = 0.2 , y = 1.0, text = "January", showarrow = F, xref='paper', yref='paper'),
    list(x = 0.8 , y = 1.0, text = "March", showarrow = F, xref='paper', yref='paper'))
)
```


### Trips by gender (1 = Male, 2 = Female)

```{r gender}
# Histogram of when people start their rides, by gender!
citibike_tidy %>% 
  group_by(gender) %>% 
  mutate(start_hour = str_sub(start_time, 0, 2),
         start_hour = as.numeric(start_hour)) %>% 
  ggplot(aes(x = start_hour)) +
  geom_histogram() +
  labs(x = "Start hour",
       y = "Frequency") +
  facet_grid(~ gender)
```

### Age ranges and average time spent on ride

```{r age_length_plot}
# who are the people over 100; also, this is kind of ug the way i have done it; whose trips are more than 500 hours??????? how is this calculated??
# Will definitely need to look into how some of these indicators are measured/calculated... This plot is pretty useless as is.
citibike_tidy %>% 
  mutate(trip_hour = trip_minutes / 60) %>% 
  ggplot(aes(x = rider_age, y = trip_hour)) + 
  geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE) +
  facet_grid(~ gender)
```

### Most/least popular days of the week of travel 



* Length of ride against day of month, by month

```{r trip_length_plot}
# Histogram of how long people ride for, by month!
# can we change the month labels??

  citibike_tidy %>% 
  mutate(start_day = as.numeric(start_day)) %>% 
  group_by(start_month, start_day) %>% 
    mutate(mean_trip_hour = mean(trip_minutes / 60)) %>% 
    ggplot(aes(x = start_day, y = mean_trip_hour, color = start_month)) +
    geom_point(alpha = 0.5) +
    geom_smooth(se = FALSE) +
    labs(x = "Day of the month",
         y = "Mean length of trip (hours)") + 
    scale_color_hue(name = "Month") +
    facet_grid(~ start_month)
```
