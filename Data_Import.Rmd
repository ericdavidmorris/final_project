---
title: "Data Import and Exploration"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(viridis)
library(ggridges)
library(plotly)
library(lubridate)
library(stringr)
library(dplyr)
```

### Introduction 

## *Data Import*

CSV zip files (corresponding to each month) of Citi Bike data for 2017 were downloaded from [the company's system data website](https://s3.amazonaws.com/tripdata/index.html), which is provided according to the [NYCBS Data Use Policy](https://www.citibikenyc.com/data-sharing-policy). Originally, we felt it was better to download directly from the data source for reproducibility purposes, however, when using read_csv with the direct URL to the zip, there were several parsing errors and the import failed. This may be due to the size of the files (zips vary from 25-70 MB). We decided to download the zips of two months of interest and add them to our project's data folder and import from there.

```{r data_import_func}
# Removed col names type for now and went with automatic column parsing which seemed to work  well

# Need to add a variable/split date so we can identify if the trip is in the January or March dataset 

citibike_import = function(file) {
  
  df = read_csv(file, col_names = TRUE) %>%
    janitor::clean_names() %>% 
    separate(start_time, into = c("start_date", "start_time"), sep = " ") %>% 
    separate(stop_time, into = c("stop_date", "stop_time"), sep = " ") %>% 
    separate(start_date, into = c("start_year", "start_month", "start_day"), sep = "-") %>% 
    separate(stop_date, into = c("stop_year", "stop_month", "stop_day"), sep = "-") %>% 
    mutate(user_type = tolower(user_type),
           gender = as.factor(gender),
           start_month = ifelse(start_month == "01", "January", "March"),
           stop_month = ifelse(start_month == "01", "January", "March"),
           trip_minutes = (trip_duration / 60),
           rider_age = (2017 - birth_year)) %>% 
    filter(user_type == "subscriber",
           trip_minutes > 5,
           trip_minutes <= 45)
    
  df
  
}

citibike_tidy = 
  bind_rows(citibike_import("./data/201701-citibike-tripdata.csv.zip"),
            citibike_import("./data/201703-citibike-tripdata.csv.zip"))

# Reading the data directly from website doesn't work - thousands of parsing failures, both with auto parsing and when specifing column parsing in function
# citibike_import("https://s3.amazonaws.com/tripdata/201701-citibike-tripdata.csv.zip"),
# citibike_import("https://s3.amazonaws.com/tripdata/201703-citibike-tripdata.csv.zip"))

```

## Research Questions of Interest:

* Most popular/used beginning station (and least)

```{r Starting Stations}

# Top 10 starting stations in the month of January

citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(start_station_id, start_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(10, n) %>% 
  arrange(desc(n)) %>% 
  select(-start_station_id) %>% 
  rename("Starting CitiBike Station (Address)" = start_station_name,
         "Number of times used" = n) %>% 
  knitr::kable(align = "c")

# Top 10 starting stations in the month of March

citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(start_station_id, start_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(10, n) %>% 
  arrange(desc(n)) %>% 
  select(-start_station_id) %>% 
  rename("Starting CitiBike Station (Address)" = start_station_name,
         "Number of times used" = n) %>% 
  knitr::kable(align = "c")


# Bottom 10 starting stations in the month of January

citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(start_station_id, start_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(-10, n) %>% 
  arrange(n) %>% 
  select(-start_station_id) %>% 
  rename("Starting CitiBike Station (Address)" = start_station_name,
         "Number of times used" = n) %>% 
  knitr::kable(align = "c")

# Bottom 10 starting stations in the month of March

citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(start_station_id, start_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(-10, n) %>% 
  arrange(n) %>% 
  select(-start_station_id) %>% 
  rename("Starting CitiBike Station (Address)" = start_station_name,
         "Number of times used" = n) %>% 
  knitr::kable(align = "c")

# Remove NYCBS Depots? 

```


* Most popular/used ending station (and least)
```{r Ending Stations}
# Top 10 terminal stations in the month of January

citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(end_station_id, end_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(10, n) %>% 
  arrange(desc(n)) %>% 
  select(-end_station_id) %>% 
  rename("Terminal CitiBike Station (Address)" = end_station_name,
         "Number of times used" = n) %>% 
  knitr::kable(align = "c")

# Top 10 terminal stations in the month of March

citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(end_station_id, end_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(10, n) %>% 
  arrange(desc(n)) %>% 
  select(-end_station_id) %>% 
  rename("Terminal CitiBike Station (Address)" = end_station_name,
         "Number of times used" = n) %>% 
  knitr::kable(align = "c")

# Bottom 10 terminal stations in the month of January

citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(end_station_id, end_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(-10, n) %>% 
  arrange(n) %>% 
  select(-end_station_id) %>% 
  rename("Terminal CitiBike Station (Address)" = end_station_name,
         "Number of times used" = n) %>% 
  knitr::kable(align = "c")

# Bottom 10 terminal stations in the month of March

citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(end_station_id, end_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(-10, n) %>% 
  arrange(n) %>% 
  select(-end_station_id) %>% 
  rename("Terminal CitiBike Station (Address)" = end_station_name,
         "Number of times used" = n) %>% 
  knitr::kable(align = "c")
```

* Mapping the above (like airbnb from class)
* ERIC!!! *

```{r Plotly}

# citibike_tidy %>% 
#  filter(start_month == "01") %>% 
#  group_by(start_station_id, start_station_name, start_station_latitude, start_station_longitude) %>% 
#  summarize(n = n()) %>% 
#  filter(n > 1000) %>% 
#  plot_ly(x = ~start_station_longitude, y = ~start_station_latitude, type = "scatter", mode = "markers",
#          alpha = 0.3, 
#          color = ~n)

##ggplot of above

## map of nyc based on lat/long, overlay ggplot on top? https://cran.r-project.org/web/packages/magick/vignettes/intro.html#combining

#Jan
citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(start_station_id, start_station_latitude, start_station_longitude) %>% 
  summarize(n = n()) %>% 
  filter(n > 100) %>% 
  ggplot(aes(x = start_station_longitude, y = start_station_latitude, color = n)) +
  geom_point(alpha = 0.3) + 
  scale_color_viridis() +
  coord_cartesian() +
  theme_classic()

#March 
citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(start_station_id, start_station_latitude, start_station_longitude) %>% 
  summarize(n = n()) %>% 
  filter(n > 100) %>% 
  ggplot(aes(x = start_station_longitude, y = start_station_latitude, color = n)) +
  geom_point(alpha = 0.3) + 
  scale_color_viridis() +
  coord_cartesian() +
  theme_classic()

## ggplot of end stations

#Jan
citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(end_station_id, end_station_latitude, end_station_longitude) %>% 
  summarize(n = n()) %>% 
  filter(n > 100) %>% 
  ggplot(aes(x = end_station_longitude, y = end_station_latitude, color = n)) +
  geom_point(alpha = 0.3) + 
  scale_color_viridis() +
  coord_cartesian() +
  theme_classic()

#March
citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(end_station_id, end_station_latitude, end_station_longitude) %>% 
  summarize(n = n()) %>% 
  filter(n > 100) %>% 
  ggplot(aes(x = end_station_longitude, y = end_station_latitude, color = n)) +
  geom_point(alpha = 0.3) + 
  scale_color_viridis() +
  coord_cartesian() +
  theme_classic()

# least used stations plotly 

#citibike_tidy %>% 
#  filter(start_month == "01") %>% 
#  group_by(start_station_name, start_station_latitude, start_station_longitude) %>%  
#  summarize(n = n()) %>% 
#  arrange(n) %>% 
#  filter(n < 500) %>% 
#  plot_ly(x = ~start_station_longitude, y = ~start_station_latitude, type = "scatter", mode = "markers",
#          alpha = 0.3, 
#          color = ~n)
```


* Men v. Women (1 = Male, 2 = Female)
```{r gender}
# Histogram of when people start their rides, by gender!
citibike_tidy %>% 
  group_by(gender) %>% 
  filter(gender != 0) %>% 
  mutate(start_hour = str_sub(start_time, 0, 2),
         start_hour = as.numeric(start_hour)) %>% 
  ggplot(aes(x = start_hour)) +
  geom_histogram() +
  labs(x = "Start hour",
       y = "Frequency") +
  facet_grid(~ gender)
```


* Age ranges and average time spent on ride
```{r age_length_plot}
# who are the people over 100; also, this is kind of ug the way i have done it; whose trips are more than 500 hours??????? how is this calculated??
citibike_tidy %>% 
  filter(gender != 0) %>% 
  mutate(trip_hour = trip_minutes / 60) %>% 
  ggplot(aes(x = rider_age, y = trip_hour)) + 
  geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE) +
  facet_grid(~ gender)
```


* Customers (24h & 3 day passes) vs. Subscribers (Annual Member)

* Plots of amounts of rides over time of day 

* Most/least popular days of the week of travel 

* Jan. vs. March trips

* Map of where people start
```{r map_start_plot}
# this looks pretty dumb; is it a scale issue?
citibike_tidy %>% 
  filter(start_station_longitude != 0) %>% 
  ggplot(aes(x = start_station_longitude, y = start_station_latitude)) + 
  geom_point()
```


* Map of where people end (kind of philosophical, no?)
```{r map_end_plot}
citibike_tidy %>% 
  filter(end_station_longitude != 0) %>% 
  ggplot(aes(x = end_station_longitude, y = end_station_latitude)) + 
  geom_point()
```


* Length of ride against day of month, by month
```{r trip_length_plot}
# Histogram of how long people ride for, by month!
# can we change the month labels??

  citibike_tidy %>% 
  mutate(start_day = as.numeric(start_day)) %>% 
  group_by(start_month, start_day) %>% 
    mutate(mean_trip_hour = mean(trip_minutes / 60)) %>% 
    ggplot(aes(x = start_day, y = mean_trip_hour, color = start_month)) +
    geom_point(alpha = 0.5) +
    geom_smooth(se = FALSE) +
    labs(x = "Day of the month",
         y = "Mean length of trip (hours)") + 
    scale_color_hue(name = "Month") +
    facet_grid(~ start_month)
```


*ongoing data questions: do we need both trip_duration and trip_minutes?
