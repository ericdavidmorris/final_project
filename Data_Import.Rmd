---
title: "Data Import"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggridges)
library(plotly)
library(lubridate)
library(stringr)
```

## Data Import

CSV zip files (corresponding to each month) of Citi Bike data for 2017 were downloaded from [the company's system data website](https://s3.amazonaws.com/tripdata/index.html). Originally, we felt it was better to download directly from the data source for reproducibility purposes. However, when using read_csv with the direct URL to the zip, there were several parsing errors and the import failed. This may be due to the size of the files (zips of 25-70 MB). We decided to download the zips of two months and add them to our project's data folder. The data is provided according to the [NYCBS Data Use Policy](https://www.citibikenyc.com/data-sharing-policy). 

```{r data_import_func}
# removed col names type for now and went with automatic column parsing which seemed to work  well

# Need to add a variable/split date so we can identify if the trip is in the January or March dataset 

citibike_import = function(file) {
  
  df = read_csv(file, col_names = TRUE) %>%
    janitor::clean_names() %>% 
    separate(start_time, into = c("start_date", "start_time"), sep = " ") %>% 
    separate(stop_time, into = c("stop_date", "stop_time"), sep = " ") %>% 
    separate(start_date, into = c("start_year", "start_month", "start_day"), sep = "-") %>% 
    separate(stop_date, into = c("stop_year", "stop_month", "stop_day"), sep = "-") %>% 
    mutate(user_type = tolower(user_type),
           trip_minutes = (trip_duration / 60),
           rider_age = (2017 - birth_year))
    
  df
  
}

citibike_tidy = 
  bind_rows(citibike_import("./data/201701-citibike-tripdata.csv.zip"),
            citibike_import("./data/201703-citibike-tripdata.csv.zip"))


# Reading the data directly from website doesn't work - thousands of parsing failures, even with auto parsing and when specifing column parsing in function
# citibike_import("https://s3.amazonaws.com/tripdata/201701-citibike-tripdata.csv.zip"),
# citibike_import("https://s3.amazonaws.com/tripdata/201703-citibike-tripdata.csv.zip"))
```

Research Questions of Interest:

* Most popular/used beginning station (and least)

```{r beg_stat_ids}
# Top 10 used beginning stations in all dataset (Jan)

citibike_tidy %>% 
  filter(start_month == "01") %>% 
  group_by(start_station_id, start_station_name) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n)) %>% 
  filter(n > 3990) %>% 
  knitr::kable()

# Top 10 used beginning stations in all dataset (March)

citibike_tidy %>% 
  filter(start_month == "03") %>% 
  group_by(start_station_id, start_station_name) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n)) %>% 
  filter(n > 4300) %>% 
  knitr::kable()

# Bottom 10 used beginning stations in all dataset (Jan)
# Remove NYCBS Depots? 

citibike_tidy %>% 
  filter(start_month == "01") %>% 
  group_by(start_station_id, start_station_name) %>% 
  summarize(n = n()) %>% 
  arrange(n) %>% 
  filter(n < 60) %>% 
  knitr::kable()

# Bottom 10 used beginning stations in all dataset (March)
# Remove NYCBS Depots? 

citibike_tidy %>% 
  filter(start_month == "03") %>% 
  group_by(start_station_id, start_station_name) %>% 
  summarize(n = n()) %>% 
  arrange(n) %>% 
  filter(n < 40) %>% 
  knitr::kable()

```


* Most popular/used ending station (and least)
```{r end_stat_ids}
# Top 10 used end stations in all dataset (Jan)

citibike_tidy %>% 
  filter(start_month == "01") %>% 
  group_by(end_station_id, end_station_name) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n)) %>% 
  filter(n > 3990) %>% 
  knitr::kable()

# Top 10 used end stations in all dataset (March)

citibike_tidy %>% 
  filter(start_month == "03") %>% 
  group_by(end_station_id, end_station_name) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n)) %>% 
  filter(n > 4300) %>% 
  knitr::kable()

# Bottom 10 used end stations in all dataset (Jan)

citibike_tidy %>% 
  filter(start_month == "01") %>% 
  group_by(end_station_id, end_station_name) %>% 
  summarize(n = n()) %>% 
  arrange(n) %>% 
  filter(n < 60) %>% 
  knitr::kable()

# Bottom 10 used end stations in all dataset (March)

citibike_tidy %>% 
  filter(start_month == "03") %>% 
  group_by(end_station_id, end_station_name) %>% 
  summarize(n = n()) %>% 
  arrange(n) %>% 
  filter(n < 40) %>% 
  knitr::kable()
```


* Mapping the above (like airbnb from class)
* ERIC!!! *

* Men v. Women (1 = Male, 2 = Female)
```{r gender}
# Histogram of when people start their rides, by gender!
citibike_tidy %>% 
  group_by(gender) %>% 
  filter(gender != 0) %>% 
  mutate(start_hour = str_sub(start_time, 0, 2),
         start_hour = as.numeric(start_hour)) %>% 
  ggplot(aes(x = start_hour)) +
  geom_histogram() +
  labs(x = "Start hour",
       y = "Frequency")
  facet_grid(~ gender)
```


* Age ranges and average time spent on ride

* Customers (24h & 3 day passes) vs. Subscribers (Annual Member)

* Plots of amounts of rides over time of day 

* Most/least popular days of the week of travel 

* Jan. vs. March trips

* Map of where people start

* Map of where people end (kind of philosophical, no?)

* Length of ride against day of month, by month
```{r}
# Histogram of how long people ride for, by month!
  citibike_tidy %>% 
  mutate(start_day = as.numeric(start_day)) %>% 
  group_by(start_month, start_day) %>% 
    mutate(mean_trip_hour = mean(trip_minutes / 60)) %>% 
    ggplot(aes(x = start_day, y = mean_trip_hour, color = start_month)) +
    geom_point(alpha = 0.5) +
    geom_smooth(se = FALSE) +
    labs(x = "Day of the month",
         y = "Mean length of trip (hours)") + 
    scale_color_hue(name = "Month") +
    facet_grid(~ start_month)
```


*ongoing data questions: do we need both trip_duration and trip_minutes?
