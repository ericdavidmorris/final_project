---
title: "Data Import and Exploration"
output:
  html_document:
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(viridis)
library(ggridges)
library(lubridate)
library(stringr)
library(kableExtra)
```

## Introduction 

Data for this project was obtained from [the company's system data website](https://s3.amazonaws.com/tripdata/index.html), which is provided according to the [NYCBS Data Use Policy](https://www.citibikenyc.com/data-sharing-policy). We downloaded CSV zip files of Citi Bike data for the corresponding months of interest in 2017. 

## Data Import

Originally, we felt it was better to download directly from the data source for reproducibility purposes, however, when using read_csv with the direct URL to the zip, there were several parsing errors and the import failed. This may be due to the size of the files (zips vary from 25-70 MB). As such, we decided to download the zips of two months of interest and add them to our project's data folder and import from there.

```{r Data Import Function}
# Removed col names type for now and went with automatic column parsing

citibike_import = function(file) {
  
  df = read_csv(file, col_names = TRUE) %>%
    janitor::clean_names() %>% 
    separate(start_time, into = c("start_date", "start_time"), sep = " ") %>% 
    separate(stop_time, into = c("stop_date", "stop_time"), sep = " ") %>% 
    separate(start_date, into = c("start_year", "start_month", "start_day"), sep = "-") %>% 
    separate(stop_date, into = c("stop_year", "stop_month", "stop_day"), sep = "-") %>% 
    mutate(user_type = tolower(user_type),
           gender = as.factor(gender - 1),
           start_month = ifelse(start_month == "01", "January", "March"),
           stop_month = ifelse(start_month == "01", "January", "March"),
           trip_minutes = (trip_duration / 60),
           rider_age = (2017 - birth_year),
           start_hour = as.numeric(str_sub(start_time, 0, 2)),
           overnight = ifelse(start_hour < 06 & start_hour >= 00, 1, 0),
           morning = ifelse(start_hour < 12 & start_hour >= 06, 1, 0),
           afternoon = ifelse(start_hour < 18 & start_hour >= 12, 1, 0),
           night = ifelse(start_hour <= 24 & start_hour >= 18, 1, 0)) %>% 
    filter(user_type == "subscriber",
           trip_minutes > 5,
           trip_minutes <= 45,
           !start_station_name %in% c("Bressler", "Kiosk in a box Motivate", "NYCBS Depot - FAR", "NYCBS Depot - SSP", "NYCBS Depot - STY", "NYCBS Depot - DYR", "NYCBS Depot BAL - DYR", "SSP Tech Workshop", "Penn Station Valet", "Penn Station Valet - Valet Scan"),
           !end_station_name %in% c("Bressler", "Kiosk in a box Motivate", "NYCBS Depot - FAR", "NYCBS Depot - SSP", "NYCBS Depot - STY", "NYCBS Depot - DYR", "NYCBS Depot BAL - DYR", "SSP Tech Workshop", "Penn Station Valet", "Penn Station Valet - Valet Scan"),
           gender != -1,
           rider_age < 100)
  
  df
  
}

citibike_tidy = 
  bind_rows(citibike_import("./data/201701-citibike-tripdata.csv.zip"),
            citibike_import("./data/201703-citibike-tripdata.csv.zip"))

# Reading the data directly from website doesn't work - thousands of parsing failures, both with auto parsing and when specifing column parsing in function
# citibike_import("https://s3.amazonaws.com/tripdata/201701-citibike-tripdata.csv.zip"),
# citibike_import("https://s3.amazonaws.com/tripdata/201703-citibike-tripdata.csv.zip"))

```


## Research Questions of Interest

### Most popular/used beginning station (and least)

```{r Starting Station Kables}

# Top 10 starting stations in the month of January

citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(start_station_id, start_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(10, n) %>% 
  arrange(desc(n)) %>% 
  mutate(n = format(n, big.mark=",")) %>%
  select(-start_station_id) %>% 
  rename("Starting CitiBike Station (Address)" = start_station_name,
         "Times used in January 2017 (n)" = n) %>% 
  knitr::kable(align = "c") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "center")

# Top 10 starting stations in the month of March

citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(start_station_id, start_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(10, n) %>% 
  arrange(desc(n)) %>%
  mutate(n = format(n, big.mark=",")) %>%
  select(-start_station_id) %>% 
  rename("Starting CitiBike Station (Address)" = start_station_name,
         "Times used in March 2017 (n)" = n) %>% 
  knitr::kable(align = "c") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "center")

# Bottom 10 starting stations in the month of January

citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(start_station_id, start_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(-10, n) %>% 
  arrange(n) %>% 
  select(-start_station_id) %>% 
  rename("Starting CitiBike Station (Address)" = start_station_name,
         "Times used in January 2017 (n)" = n) %>% 
  knitr::kable(align = "c") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "center")

# Bottom 10 starting stations in the month of March

citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(start_station_id, start_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(-10, n) %>% 
  arrange(n) %>% 
  select(-start_station_id) %>% 
  rename("Starting CitiBike Station (Address)" = start_station_name,
         "Times used in March 2017 (n)" = n) %>% 
  knitr::kable(align = "c") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "center")
```


### Most popular/used ending station (and least)

```{r Ending Station Kables}
# Top 10 terminal stations in the month of January

citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(end_station_id, end_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(10, n) %>% 
  arrange(desc(n)) %>% 
  mutate(n = format(n, big.mark=",")) %>%
  select(-end_station_id) %>% 
  rename("Terminal CitiBike Station (Address)" = end_station_name,
         "Times used in January 2017 (n)" = n) %>% 
  knitr::kable(align = "c") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "center")

# Top 10 terminal stations in the month of March

citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(end_station_id, end_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(10, n) %>% 
  arrange(desc(n)) %>% 
  mutate(n = format(n, big.mark=",")) %>%
  select(-end_station_id) %>% 
  rename("Terminal CitiBike Station (Address)" = end_station_name,
         "Times used in March 2017 (n)" = n) %>% 
  knitr::kable(align = "c") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "center")

# Bottom 10 terminal stations in the month of January

citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(end_station_id, end_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(-10, n) %>% 
  arrange(n) %>% 
  select(-end_station_id) %>% 
  rename("Terminal CitiBike Station (Address)" = end_station_name,
         "Times used in January 2017 (n)" = n) %>% 
  knitr::kable(align = "c") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "center")

# Bottom 10 terminal stations in the month of March

citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(end_station_id, end_station_name) %>% 
  summarize(n = n()) %>% 
  ungroup() %>% 
  top_n(-10, n) %>% 
  arrange(n) %>% 
  select(-end_station_id) %>% 
  rename("Terminal CitiBike Station (Address)" = end_station_name,
         "Times used in March 2017 (n)" = n) %>% 
  knitr::kable(align = "c") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F, position = "center")
```


### Mapping the above (like airbnb from class)
* ERIC!!! *
* Maybe we could move this over to the Visualizations page? - Grace*

```{r Plotly}

#plotly works nicely now

citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(start_station_name, start_station_latitude, start_station_longitude) %>% 
  summarize(n = n()) %>% 
  mutate(text_label = str_c("Station name: ", start_station_name, '\n# of trips started at this station: ', n)) %>% 
  plot_ly(x = ~start_station_longitude, y = ~start_station_latitude, type = "scatter", mode = "markers",
          alpha = 0.5,
          color = ~n,
          text = ~text_label)

## map of nyc based on lat/long, overlay ggplot on top? https://cran.r-project.org/web/packages/magick/vignettes/intro.html#combining

#Jan ggplot of plotly above

#citibike_tidy %>% 
#  filter(start_month == "January") %>% 
#  group_by(start_station_id, start_station_latitude, start_station_longitude) %>% 
#  summarize(n = n()) %>% 
#  ggplot(aes(x = start_station_longitude, y = start_station_latitude, color = n)) +
#  geom_point(alpha = 0.3) + 
#  scale_color_viridis() +
#  coord_cartesian() +
#  theme_classic()

citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(start_station_name, start_station_latitude, start_station_longitude) %>% 
  summarize(n = n()) %>% 
  mutate(text_label = str_c("Station name: ", start_station_name, '\n# of trips started at this station: ', n)) %>% 
  plot_ly(x = ~start_station_longitude, y = ~start_station_latitude, type = "scatter", mode = "markers",
          alpha = 0.5,
          color = ~n,
          text = ~text_label)

#March ggplot of plotly above

#citibike_tidy %>% 
#  filter(start_month == "March") %>% 
#  group_by(start_station_id, start_station_latitude, start_station_longitude) %>% 
#  summarize(n = n()) %>% 
#  ggplot(aes(x = start_station_longitude, y = start_station_latitude, color = n)) +
#  geom_point(alpha = 0.3) + 
#  scale_color_viridis() +
#  coord_cartesian() +
#  theme_classic()

citibike_tidy %>% 
  filter(start_month == "January") %>% 
  group_by(end_station_name, end_station_latitude, end_station_longitude) %>% 
  summarize(n = n()) %>% 
  mutate(text_label = str_c("Station name: ", end_station_name, '\n# of trips ended at this station: ', n)) %>% 
  plot_ly(x = ~end_station_longitude, y = ~end_station_latitude, type = "scatter", mode = "markers",
          alpha = 0.5,
          color = ~n,
          text = ~text_label)

#Jan ggplot of plotly above
#citibike_tidy %>% 
#  filter(start_month == "January") %>% 
#  group_by(end_station_id, end_station_latitude, end_station_longitude) %>% 
#  summarize(n = n()) %>% 
#  ggplot(aes(x = end_station_longitude, y = end_station_latitude, color = n)) +
#  geom_point(alpha = 0.3) + 
#  scale_color_viridis() +
#  coord_cartesian() +
#  theme_classic()

citibike_tidy %>% 
  filter(start_month == "March") %>% 
  group_by(end_station_name, end_station_latitude, end_station_longitude) %>% 
  summarize(n = n()) %>% 
  mutate(text_label = str_c("Station name: ", end_station_name, '\n# of trips ended at this station: ', n)) %>% 
  plot_ly(x = ~end_station_longitude, y = ~end_station_latitude, type = "scatter", mode = "markers",
          alpha = 0.5,
          color = ~n,
          text = ~text_label)

#March ggplot of plotly above
#citibike_tidy %>% 
#  filter(start_month == "March") %>% 
#  group_by(end_station_id, end_station_latitude, end_station_longitude) %>% 
#  summarize(n = n()) %>% 
#  ggplot(aes(x = end_station_longitude, y = end_station_latitude, color = n)) +
#  geom_point(alpha = 0.3) + 
#  scale_color_viridis() +
#  coord_cartesian() +
#  theme_classic()
```


* Trips by gender (1 = Male, 2 = Female)

```{r gender}
# Histogram of when people start their rides, by gender!
citibike_tidy %>% 
  group_by(gender) %>% 
  mutate(start_hour = str_sub(start_time, 0, 2),
         start_hour = as.numeric(start_hour)) %>% 
  ggplot(aes(x = start_hour)) +
  geom_histogram() +
  labs(x = "Start hour",
       y = "Frequency") +
  facet_grid(~ gender)
```

* Age ranges and average time spent on ride

```{r age_length_plot}
# who are the people over 100; also, this is kind of ug the way i have done it; whose trips are more than 500 hours??????? how is this calculated??
# Will definitely need to look into how some of these indicators are measured/calculated... This plot is pretty useless as is.
citibike_tidy %>% 
  mutate(trip_hour = trip_minutes / 60) %>% 
  ggplot(aes(x = rider_age, y = trip_hour)) + 
  geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE) +
  facet_grid(~ gender)
```

* Most/least popular days of the week of travel 

* Simple linear regression of trip duration vs. age, sex, time of day (categorical: morning rush hour, morning, evening rush hour), day of week

```{r}
# exploring a model for predicting trip duration

lm(trip_duration ~ rider_age + gender + overnight + morning + afternoon + night, 
   data = citibike_tidy) %>% 
  broom::tidy()
```

* Length of ride against day of month, by month

```{r trip_length_plot}
# Histogram of how long people ride for, by month!
# can we change the month labels??

  citibike_tidy %>% 
  mutate(start_day = as.numeric(start_day)) %>% 
  group_by(start_month, start_day) %>% 
    mutate(mean_trip_hour = mean(trip_minutes / 60)) %>% 
    ggplot(aes(x = start_day, y = mean_trip_hour, color = start_month)) +
    geom_point(alpha = 0.5) +
    geom_smooth(se = FALSE) +
    labs(x = "Day of the month",
         y = "Mean length of trip (hours)") + 
    scale_color_hue(name = "Month") +
    facet_grid(~ start_month)
```

